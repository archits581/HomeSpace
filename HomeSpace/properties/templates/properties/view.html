{% extends 'base.html' %}
{% load static %}

{% block styles %}

    <!-- MAPBOX LEAFLET CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>

    <!-- MAPBOX LEAFLET JAVASCRIPT -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>

    <!-- BOOTSTRAP CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- JQUERY -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- FONT AWESOME KIT CODE -->
    <script src="https://kit.fontawesome.com/3d6760da32.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/view.css' %}">
   
    <!-- POPPINS FONT -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
   
    <!-- INTER FONT -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;500;700;900&display=swap" rel="stylesheet">
       
    <!-- ROBOTO FONT -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;900&display=swap" rel="stylesheet">
   

{% endblock %}


{% block content %}

    <!-- CONTENT -->
    <!-- <div class="container main-container">
        <div class="content-container">
            <div class="desc-container">
                <div class="property-description">
                    <h4>Description</h4>
                    <p>{{ property.description }}</p>
                </div>

                <div class="facilities">
                    <h4>Amenities</h4>

                    <div class="item-container">
                        {% if property.furnished == 'Furnished' or property.furnished == 'Semi Furnished' %}
                        <div class="fac-item">
                            <div class="icon">
                                <i class="fas fa-couch"></i>
                            </div>
                            <p>Furnished</p>
                        </div>
                        {% endif %}

                        
                        {% if property.play_area %}
                        <div class="fac-item">
                            <div class="icon">
                                <i class="fas fa-biking"></i>
                            </div>
                            <p>Play Area</p> 
                        </div>
                        {% endif %} 

                        {% if property.gym %}                        
                        <div class="fac-item">
                            <div class="icon">
                                <i class="fas fa-dumbbell"></i>
                            </div>
                            <p>Gym</p>
                        </div>
                        {% endif %}

                        {% if property.club_house %}
                        <div class="fac-item">
                            <div class="icon">
                                <i class="fas fa-house-user"></i>
                            </div>
                            <p>Club House</p>
                        </div>
                        {% endif %}

                        {% if property.lift %}
                        <div class="fac-item">
                            <div class="icon">
                                <img style="width: 45px;" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNDkwLjY2NyA0OTAuNjY3IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA0OTAuNjY3IDQ5MC42Njc7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnPg0KCTxnPg0KCQk8cGF0aCBkPSJNNDgwLDBIMTAuNjY3QzQuNzc5LDAsMCw0Ljc3OSwwLDEwLjY2N1Y0ODBjMCw1Ljg4OCw0Ljc3OSwxMC42NjcsMTAuNjY3LDEwLjY2N0g5NmM1Ljg4OCwwLDEwLjY2Ny00Ljc3OSwxMC42NjctMTAuNjY3DQoJCQl2LTEwLjY2N0gzODRWNDgwYzAsNS44ODgsNC43NzksMTAuNjY3LDEwLjY2NywxMC42NjdINDgwYzUuODg4LDAsMTAuNjY3LTQuNzc5LDEwLjY2Ny0xMC42NjdWMTAuNjY3DQoJCQlDNDkwLjY2Nyw0Ljc3OSw0ODUuODg4LDAsNDgwLDB6IE00NjkuMzMzLDQ2OS4zMzNoLTY0di0xMC42NjdjMC01Ljg4OC00Ljc3OS0xMC42NjctMTAuNjY3LTEwLjY2N0g5Ng0KCQkJYy01Ljg4OCwwLTEwLjY2Nyw0Ljc3OS0xMC42NjcsMTAuNjY3djEwLjY2N2gtNjR2LTQ0OGg0NDhWNDY5LjMzM3oiLz4NCgk8L2c+DQo8L2c+DQo8Zz4NCgk8Zz4NCgkJPHBhdGggZD0iTTM5NC42NjcsMTA2LjY2N0g5NmMtNS44ODgsMC0xMC42NjcsNC43NzktMTAuNjY3LDEwLjY2N3YzNDEuMzMzYzAsNS44ODgsNC43NzksMTAuNjY3LDEwLjY2NywxMC42NjdoMjk4LjY2Nw0KCQkJYzUuODg4LDAsMTAuNjY3LTQuNzc5LDEwLjY2Ny0xMC42NjdWMTE3LjMzM0M0MDUuMzMzLDExMS40NDUsNDAwLjU1NSwxMDYuNjY3LDM5NC42NjcsMTA2LjY2N3ogTTM4NCw0NDhIMTA2LjY2N1YxMjhIMzg0VjQ0OHoiLz4NCgk8L2c+DQo8L2c+DQo8Zz4NCgk8Zz4NCgkJPHBhdGggZD0iTTI0NS4zMzMsMTA2LjY2N2MtNS44ODgsMC0xMC42NjcsNC43NzktMTAuNjY3LDEwLjY2N3YzNDEuMzMzYzAsNS44ODgsNC43NzksMTAuNjY3LDEwLjY2NywxMC42NjcNCgkJCVMyNTYsNDY0LjU1NSwyNTYsNDU4LjY2N1YxMTcuMzMzQzI1NiwxMTEuNDQ1LDI1MS4yMjEsMTA2LjY2NywyNDUuMzMzLDEwNi42Njd6Ii8+DQoJPC9nPg0KPC9nPg0KPGc+DQoJPGc+DQoJCTxjaXJjbGUgY3g9IjQzNy4zMzMiIGN5PSIyMjQiIHI9IjEwLjY2NyIvPg0KCTwvZz4NCjwvZz4NCjxnPg0KCTxnPg0KCQk8Y2lyY2xlIGN4PSI0MzcuMzMzIiBjeT0iMjY2LjY2NyIgcj0iMTAuNjY3Ii8+DQoJPC9nPg0KPC9nPg0KPGc+DQoJPGc+DQoJCTxwYXRoIGQ9Ik0yMTAuMjE5LDY3LjEzNmwtMjEuMzMzLTIxLjMzM2MtNC4xNi00LjE2LTEwLjkyMy00LjE2LTE1LjA4MywwbC0yMS4zMzMsMjEuMzMzYy00LjE2LDQuMTYtNC4xNiwxMC45MjMsMCwxNS4wODMNCgkJCWM0LjE2LDQuMTYsMTAuOTIzLDQuMTYsMTUuMDgzLDBsMTMuNzgxLTEzLjgwM2wxMy43ODEsMTMuODAzYzIuMDkxLDIuMDY5LDQuODIxLDMuMTE1LDcuNTUyLDMuMTE1DQoJCQljMi43MzEsMCw1LjQ2MS0xLjA0NSw3LjU1Mi0zLjExNUMyMTQuMzc5LDc4LjA1OSwyMTQuMzc5LDcxLjI5NiwyMTAuMjE5LDY3LjEzNnoiLz4NCgk8L2c+DQo8L2c+DQo8Zz4NCgk8Zz4NCgkJPHBhdGggZD0iTTMzOC4xOTcsNDUuODAzYy00LjE2LTQuMTYtMTAuOTIzLTQuMTYtMTUuMDgzLDBsLTEzLjc4MSwxMy43ODFsLTEzLjgwMy0xMy43ODFjLTQuMTYtNC4xNi0xMC45MjMtNC4xNi0xNS4wODMsMA0KCQkJYy00LjE2LDQuMTYtNC4xNiwxMC45MjMsMCwxNS4wODNsMjEuMzMzLDIxLjMzM2MyLjA5MSwyLjA2OSw0LjgyMSwzLjExNSw3LjU1MiwzLjExNXM1LjQ2MS0xLjA0NSw3LjUzMS0zLjExNWwyMS4zMzMtMjEuMzMzDQoJCQlDMzQyLjM1Nyw1Ni43MjUsMzQyLjM1Nyw0OS45NjMsMzM4LjE5Nyw0NS44MDN6Ii8+DQoJPC9nPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPC9zdmc+DQo=" />
                            </div>
                            <p>Elevator</p>
                        </div>
                        {% endif %}
                    </div> 

                    <div class="rent">
                        <div class="rent-container">
                            <p>Rent: &#8377; {{property.rent}}</p>
                        </div>

                        {% if shortlisted %}
                            <div class="remove-btn-container">
                                <button class="shortlist-btn" id="{{property.pk}}remove" onclick="remove(event, '{{property.pk}}')" ><i class="fas fa-minus-circle"></i> Remove</button>
                            </div>
                        {% else %}
                        <div class="shortlist-btn-container">
                            <a href="" class="shortlist-btn"><i class="far fa-bookmark"></i> Shortlist</a>
                        </div>
                        {% endif %}
                        <div class="contact-btn-container">
                            <button type="button" class="btn btn-primary contact-btn" data-toggle="modal" data-target="#exampleModal">
                                <i class="fas fa-phone"></i>  Contact Owner 
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="map-container">
                <div id="mapid">

                </div>
            </div>
        </div>
    </div> -->

<!-- NEW -->
<div class="container">
    <div class="first" style="margin-top:100px; margin-bottom: 100px;">
        <div class="row">
            <!-- INFO SECTION -->
            <div class="col-lg-6 first-col">
                <div class="contain">
                    <div class="description">
                        <h4>Description</h4>
                        <p>{{property.description}}</p>
                    </div>
                    <div class="amenities">
                        <h4>Amenities</h4>
                        <ul>
                            {% if property.lift %}
                                <li>Elevator</li>
                            {% endif %}
                            {% if property.play_area %}
                                <li>Children's Play Area</li>
                            {% endif %}
                            {% if property.internet_services %}
                                <li>Internet Services</li>
                            {% endif %}
                            {% if property.club_house %}
                                <li>Club House</li>
                            {% endif %}
                            {% if property.swimming_pool %}
                                <li>Swimming Pool</li>
                            {% endif %}
                            {% if property.security %}
                                <li>Security</li>
                            {% endif %}
                            {% if property.gym %}
                                <li>Gym</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="buttons">
                        <div class="row mt-5">
                            <div class="col-md-4 rent-info">
                                <p>Rent: &#8377; {{property.rent}}</p>
                            </div>
                            {% if request.user.is_authenticated and request.user == property.user %}
                            <div class="col-md-4">
                                <button class="shortlist-btn" id="{{property.pk}}remove"  ><i class="fas fa-trash-alt"></i> Remove</button>
                            </div>
                            {% elif shortlisted %}
                            <div class="col-md-4">
                                <button class="shortlist-btn" id="{{property.pk}}remove" onclick="remove(event, '{{property.pk}}')" ><i class="fas fa-minus-circle"></i> Remove</button>
                            </div>
                            {% else %}
                            <div class="col-md-4">
                                <button onclick="shortlist(event, '{{property.pk}}')" class="shortlist-btn"><i class="far fa-bookmark"></i> Shortlist</button>
                            </div>
                            {% endif %}
                            <div class="col-md-4">
                                <button type="button" class="contact-btn" data-toggle="modal" data-target="#exampleModal">
                                    <i class="fas fa-phone"></i>  Contact 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- MAP SECTION -->
            <div class="col-lg-6 second-col">
                <div id="mapid">
    
                </div>
            </div>
        </div>
    </div>
</div>



<!-- IMAGES SECTION -->
    <div class="container image-container">
        <h3 style="margin-bottom: 50px; padding-top: 20px;"> <i class="far fa-images"></i> Photos</h3>
        <div class="images">
            {% for image in property.propertyimage_set.all %}
                <img src="{{ image.image.url }}" alt="" class="property-image">
            {% endfor %}
        </div>
    </div>



    <!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Phone number: {{phone_number.contact_number}}
          <br>
          Email: {{owner.email}}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


{% endblock %}


{% block javascript %}

<!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


<!-- SCRIPT TO MANIPULATE MAP -->
<script defer>
    var mymap = L.map('mapid', {center: ['{{lat}}', '{{long}}'], zoom: 12});
      console.log('{{lat}}', '{{long}}')
         //MAPBOX Tiles
         L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoiYXJjaGl0czU4MSIsImEiOiJja2l4a29pdDkxNDd5MzBtZWc1bWVlcXI3In0.u51pVkC31mtgojLDY69ZVQ'
        }).addTo(mymap);


        $('#mymap').ready(function(e){
            marker = new L.marker([ '{{ lat }}', '{{ long }}']).addTo(mymap)
        })

        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        document.body.appendChild(lightbox);
        
        const images = document.querySelectorAll('.property-image');
        console.log(images)
        images.forEach(image =>{
            image.addEventListener('click', e =>{
                lightbox.classList.add('active');
                const img = document.createElement('img');
                img.src = image.src
                while(lightbox.firstChild){
                    lightbox.removeChild(lightbox.firstChild)
                }
                lightbox.appendChild(img)
            })
        })


        lightbox.addEventListener('click', e =>{
            if(e.target != e.currentTarget){
                return;
            }
            lightbox.classList.remove('active');
        })

</script>

<script>
    function remove(event, pk){
      console.log(pk);
        $.ajax({
            type: "POST",
            url: "{% url 'properties:ajax_remove_shortlisted' pk=property.pk %}",
            dataType: 'json',
            data:{
                'csrfmiddlewaretoken': "{{ csrf_token }}"
            },
            success: function(){
                window.location.href = "{% url 'properties:shortlisted' %}"
            },
            error: function(){
                alert("Could not perform operation")
            }
        })
    }



    function shortlist(event, pk){
          console.log('going on....')
          var shortlistURL = `{% url 'properties:shortlist' pk=property.pk %}`
          $.ajax({
                type: "POST",
                url: shortlistURL,
                data:{
                    'csrfmiddlewaretoken': "{{ csrf_token }}"
                },
                dataType: 'json',
                success: function(){
                    window.location.href = "{% url 'properties:shortlisted' %}";
                    console.log('Done!')
                },
                error: function(){
                    alert("Could not perform action");
                }
            });
        }
</script>

{% endblock %}